#!/bin/bash

# –°–∫—Ä–∏–ø—Ç —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è Velach Bot —á–µ—Ä–µ–∑ SSH
# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: ./deploy-ssh.sh

set -e

echo "üöÄ –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ Velach Bot —á–µ—Ä–µ–∑ SSH"
echo "======================================"

# –ó–∞–ø—Ä–æ—Å –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
read -p "–í–≤–µ–¥–∏—Ç–µ IP –∞–¥—Ä–µ—Å —Å–µ—Ä–≤–µ—Ä–∞: " SERVER_IP
read -p "–í–≤–µ–¥–∏—Ç–µ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ: " SERVER_USER
read -p "–í–≤–µ–¥–∏—Ç–µ –ø—É—Ç—å –∫ SSH –∫–ª—é—á—É (–∏–ª–∏ –Ω–∞–∂–º–∏—Ç–µ Enter –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –ø–∞—Ä–æ–ª—è): " SSH_KEY_PATH

# –ó–∞–ø—Ä–æ—Å —Ç–æ–∫–µ–Ω–∞ –±–æ—Ç–∞
read -p "–í–≤–µ–¥–∏—Ç–µ —Ç–æ–∫–µ–Ω Telegram –±–æ—Ç–∞: " BOT_TOKEN

# –ó–∞–ø—Ä–æ—Å –ø–∞—Ä–æ–ª—è –¥–ª—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
read -s -p "–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å –¥–ª—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö: " DB_PASSWORD
echo ""

# –°–æ–∑–¥–∞–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ —Ñ–∞–π–ª–∞ —Å –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–º–∏ –æ–∫—Ä—É–∂–µ–Ω–∏—è
cat > temp_env.txt << EOF
# Database Configuration
VELACH_BOT_DB_HOST=127.0.0.1
VELACH_BOT_DB_PORT=5432
VELACH_BOT_DB_DATABASE=velach_bot
VELACH_BOT_DB_USER=velach_bot
VELACH_BOT_DB_PASSWORD=$DB_PASSWORD
VELACH_BOT_DB_MIN_POOL_SIZE=1
VELACH_BOT_DB_MAX_POOL_SIZE=10

# Telegram Bot Configuration
VELACH_BOT_TELEGRAM_TOKEN=$BOT_TOKEN

# Server Configuration
VELACH_BOT_HOST=127.0.0.1
VELACH_BOT_PORT=20000

# Security
VELACH_BOT_JWT_SECRET=$(openssl rand -hex 32)
VELACH_BOT_ADMIN_PASSCODE_TTL=60

# Message Configuration
VELACH_BOT_MAX_MESSAGE_AGE=60
EOF

echo "üìã –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—é..."

# –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∫–æ–º–∞–Ω–¥—ã SSH
if [ -n "$SSH_KEY_PATH" ]; then
    SSH_CMD="ssh -i $SSH_KEY_PATH $SERVER_USER@$SERVER_IP"
    SCP_CMD="scp -i $SSH_KEY_PATH"
else
    SSH_CMD="ssh $SERVER_USER@$SERVER_IP"
    SCP_CMD="scp"
fi

echo "üîó –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Å–µ—Ä–≤–µ—Ä—É $SERVER_USER@$SERVER_IP..."

# –°–æ–∑–¥–∞–Ω–∏–µ —Å–∫—Ä–∏–ø—Ç–∞ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è –¥–ª—è —Å–µ—Ä–≤–µ—Ä–∞
cat > remote_deploy.sh << 'REMOTE_SCRIPT'
#!/bin/bash

set -e

echo "üöÄ –ù–∞—á–∏–Ω–∞–µ–º —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ Velach Bot –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ..."

# –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã
echo "üì¶ –û–±–Ω–æ–≤–ª—è–µ–º —Å–∏—Å—Ç–µ–º—É..."
sudo apt update

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Node.js
if ! command -v node &> /dev/null; then
    echo "üì¶ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º Node.js..."
    curl -fsSL https://deb.nodesource.com/setup_22.x | sudo -E bash -
    sudo apt-get install -y nodejs
else
    echo "‚úÖ Node.js —É–∂–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
fi

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ PostgreSQL
if ! command -v psql &> /dev/null; then
    echo "üì¶ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º PostgreSQL..."
    sudo apt install -y postgresql postgresql-contrib
else
    echo "‚úÖ PostgreSQL —É–∂–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
fi

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ PM2
if ! command -v pm2 &> /dev/null; then
    echo "üì¶ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º PM2..."
    sudo npm install -g pm2
else
    echo "‚úÖ PM2 —É–∂–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
fi

# –°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
echo "üóÑÔ∏è –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö..."
sudo -u postgres psql -c "CREATE USER velach_bot WITH PASSWORD '$DB_PASSWORD';" 2>/dev/null || echo "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å velach_bot —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç"
sudo -u postgres psql -c "CREATE DATABASE velach_bot OWNER velach_bot;" 2>/dev/null || echo "–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö velach_bot —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç"

# –°–æ–∑–¥–∞–Ω–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –¥–ª—è –ø—Ä–æ–µ–∫—Ç–∞
echo "üìÅ –°–æ–∑–¥–∞–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –ø—Ä–æ–µ–∫—Ç–∞..."
sudo mkdir -p /opt/velach_bot
sudo chown $USER:$USER /opt/velach_bot

# –ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
echo "üì• –ö–ª–æ–Ω–∏—Ä—É–µ–º —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π..."
cd /opt/velach_bot
if [ -d "velach_bot_mrgnl" ]; then
    cd velach_bot_mrgnl
    git pull origin master
else
    git clone https://github.com/mrgnl044/velach_bot_mrgnl.git
    cd velach_bot_mrgnl
fi

# –ü–µ—Ä–µ—Ö–æ–¥ –≤ –ø–∞–ø–∫—É server
cd server

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
echo "üì¶ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏..."
npm install

# –°–æ–∑–¥–∞–Ω–∏–µ .env —Ñ–∞–π–ª–∞
echo "‚öôÔ∏è –°–æ–∑–¥–∞–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é..."
cp .env.example .env
sed -i "s/your_telegram_bot_token_here/$BOT_TOKEN/g" .env
sed -i "s/your_secure_password/$DB_PASSWORD/g" .env

# –°–±–æ—Ä–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞
echo "üî® –°–æ–±–∏—Ä–∞–µ–º –ø—Ä–æ–µ–∫—Ç..."
npm run build

# –°–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü
echo "üóÑÔ∏è –°–æ–∑–¥–∞–µ–º —Ç–∞–±–ª–∏—Ü—ã –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö..."
npm run create-tables

# –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–π
echo "üîÑ –ü—Ä–∏–º–µ–Ω—è–µ–º –º–∏–≥—Ä–∞—Ü–∏–∏..."
npm run apply-migrations

# –ó–∞–ø—É—Å–∫ —á–µ—Ä–µ–∑ PM2
echo "üöÄ –ó–∞–ø—É—Å–∫–∞–µ–º –±–æ—Ç–∞..."
pm2 delete velach-bot 2>/dev/null || true
pm2 start dist/main.js --name "velach-bot"
pm2 save
pm2 startup

echo "‚úÖ –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ!"
echo ""
echo "üìã –ü–æ–ª–µ–∑–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:"
echo "   –ü—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤: pm2 logs velach-bot"
echo "   –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫: pm2 restart velach-bot"
echo "   –°—Ç–∞—Ç—É—Å: pm2 status"
echo ""
echo "üîó –ë–æ—Ç –¥–æ—Å—Ç—É–ø–µ–Ω –Ω–∞ –ø–æ—Ä—Ç—É 20000"
REMOTE_SCRIPT

# –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–æ–≤ –Ω–∞ —Å–µ—Ä–≤–µ—Ä
echo "üì§ –ö–æ–ø–∏—Ä—É–µ–º —Ñ–∞–π–ª—ã –Ω–∞ —Å–µ—Ä–≤–µ—Ä..."
$SCP_CMD remote_deploy.sh $SERVER_USER@$SERVER_IP:/tmp/
$SCP_CMD temp_env.txt $SERVER_USER@$SERVER_IP:/tmp/

# –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
echo "üîß –í—ã–ø–æ–ª–Ω—è–µ–º —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ..."
$SSH_CMD "chmod +x /tmp/remote_deploy.sh && DB_PASSWORD='$DB_PASSWORD' BOT_TOKEN='$BOT_TOKEN' /tmp/remote_deploy.sh"

# –û—á–∏—Å—Ç–∫–∞ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
echo "üßπ –û—á–∏—â–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã..."
rm -f temp_env.txt remote_deploy.sh
$SSH_CMD "rm -f /tmp/remote_deploy.sh /tmp/temp_env.txt"

echo "‚úÖ –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ!"
echo ""
echo "üîó –ë–æ—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –¥–æ—Å—Ç—É–ø–µ–Ω –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ $SERVER_IP:20000"
echo "üìã –î–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –±–æ—Ç–æ–º –ø–æ–¥–∫–ª—é—á–∏—Ç–µ—Å—å –∫ —Å–µ—Ä–≤–µ—Ä—É –∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–º–∞–Ω–¥—ã PM2" 